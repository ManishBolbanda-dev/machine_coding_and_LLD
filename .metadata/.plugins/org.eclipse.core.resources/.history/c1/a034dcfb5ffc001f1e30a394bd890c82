package service;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import models.Board;
import models.Player;

public class BoardService {
	
	private static final int MAX_SIX_THRESHOLD = 3;
	Map<Integer, Integer> movePositions;
	private Board board;
	private final int SIX = 6;
	List<Player> winners = new ArrayList<>();
	
	
	public BoardService(Board board) {
		this.board = board;
		this.movePositions = new HashMap<>();
	}
	
	void loadSnakesAndLadders(){
		this.board.getSnakes().forEach(s  -> movePositions.put(s.getFrom(), s.getTo()));
		this.board.getLadders().forEach(lad  -> movePositions.put(lad.getFrom(), lad.getTo()));
	}
	void shufflePlayer() {
		// shuffle players
	}
	public List<Player> startGame(){
		
		while(this.board.getPlayers().size()>1) {
			Player cp = this.board.getCurrentPlayer();
			int prevPosition = cp.getCurrentPosition();
			int diceValue = this.board.getDice().roll();
			int sixCount = 0;
			while(diceValue == this.SIX) {
				sixCount++;
				if(sixCount == MAX_SIX_THRESHOLD) {
					cp.setCurrentPosition(prevPosition);
					break;
				}
				this.updatePlayerPosition(cp, diceValue);
				if(hasPlayerWon(cp)) {
					break;
				}
				diceValue = this.board.getDice().roll();
			}
			updatePlayerPosition(cp, diceValue);
			if(!hasPlayerWon(cp)) {
				this.board.keepNextPlayerReady();
			}			
		}
		return winners;
	}

	private boolean hasPlayerWon(Player cp) {
		boolean hasWon = cp.getCurrentPosition() == this.board.getEnd();
		if(hasWon) {
			this.winners.add(cp);
			this.board.getPlayers().remove();
		}
		return hasWon;
	}

	private void updatePlayerPosition(Player cp, int diceValue) {
		int newPosition = cp.getCurrentPosition()+diceValue ; 
		if( newPosition <= this.board.getEnd()) {
			cp.setCurrentPosition(newPosition);
		}
	}
	
}
